<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Live Player</title>
    <style>
        body { background-color: #0f172a; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; color: white; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 850px; display: flex; flex-direction: column; height: 100vh; }
        .player-section { position: sticky; top: 0; background: #0f172a; z-index: 1000; padding: 15px 15px 0 15px; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 12px; background: #000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .title-box { margin-top: 15px; padding: 15px; background: #1e293b; border-left: 5px solid #38bdf8; border-radius: 8px; margin-bottom: 10px; }
        #video-title { margin: 0; font-size: 16px; color: #f8fafc; font-weight: 600; }
        .scrollable-content { overflow-y: auto; flex: 1; padding: 0 15px 15px 15px; }
        .playlist-header { font-size: 18px; color: #38bdf8; margin-bottom: 15px; display: block; border-bottom: 1px solid #334155; padding-bottom: 8px; margin-top: 10px; }
        .video-grid { display: grid; grid-template-columns: repeat(1, 1fr); gap: 15px; width: 100%; }
        .video-card { background: #1e293b; border-radius: 12px; overflow: hidden; cursor: pointer; border: 1px solid #334155; display: flex; align-items: center; gap: 10px; padding: 8px; }
        .video-card .thumb { width: 120px; aspect-ratio: 16/9; border-radius: 8px; background-size: cover; background-position: center; flex-shrink: 0; }
        .video-card h4 { margin: 0; font-size: 13px; color: #e2e8f0; line-height: 1.4; }
    </style>
</head>
<body>

    <div class="container">
        <div class="player-section">
            <div class="video-wrapper">
                <iframe id="tv-player" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen referrerpolicy="no-referrer"></iframe>
            </div>
            <div class="title-box">
                <h2 id="video-title">Loading...</h2>
            </div>
        </div>

        <div class="scrollable-content">
            <span class="playlist-header">More Videos</span>
            <div class="video-grid" id="video-list-ui"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDn6lT5Ort7QmCOgig-48gTaANsHKpDIhY",
            authDomain: "photox-44326.firebaseapp.com",
            databaseURL: "https://photox-44326-default-rtdb.firebaseio.com", 
            projectId: "photox-44326",
            storageBucket: "photox-44326.firebasestorage.app",
            messagingSenderId: "288633148184",
            appId: "1:288633148184:web:a7e361e9ae8c0e2ea0c46d"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const dbRef = ref(database, 'video_list');

        function fixYoutubeUrl(url) {
            let id = "";
            if(url.includes("v=")) id = url.split("v=")[1].split("&")[0];
            else if(url.includes("youtu.be/")) id = url.split("youtu.be/")[1].split("?")[0];
            else if(url.includes("embed/")) id = url.split("embed/")[1].split("?")[0];
            // অতিরিক্ত প্যারামিটার যোগ করা হয়েছে যাতে প্লে নিশ্চিত হয়
            return id ? `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&showinfo=0` : url;
        }

        onValue(dbRef, (snapshot) => {
            const data = snapshot.val();
            const listUI = document.getElementById('video-list-ui');
            const player = document.getElementById('tv-player');
            const mainTitle = document.getElementById('video-title');
            listUI.innerHTML = "";

            if (data) {
                const keys = Object.keys(data).reverse(); 
                if(!player.src || player.src.includes(window.location.hostname)) {
                    player.src = fixYoutubeUrl(data[keys[0]].url);
                    mainTitle.innerText = data[keys[0]].title;
                }

                keys.forEach(key => {
                    const video = data[key];
                    const finalUrl = fixYoutubeUrl(video.url);
                    const videoId = finalUrl.split("embed/")[1].split("?")[0];
                    const thumbUrl = video.customThumb || `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;

                    const card = document.createElement('div');
                    card.className = 'video-card';
                    card.innerHTML = `
                        <div class="thumb" style="background-image: url('${thumbUrl}')"></div>
                        <h4>${video.title}</h4>
                    `;
                    card.onclick = () => {
                        player.src = finalUrl + "&autoplay=1";
                        mainTitle.innerText = video.title;
                        document.querySelector('.scrollable-content').scrollTop = 0;
                    };
                    listUI.appendChild(card);
                });
            }
        });

        // Exit logic
        history.pushState(null, null, location.href);
        window.onpopstate = () => {
            if(confirm("Exit App?")) { window.close(); window.location.href="about:blank"; }
            else history.pushState(null, null, location.href);
        };
    </script>
</body>
</html>